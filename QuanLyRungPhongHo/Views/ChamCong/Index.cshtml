@{
    ViewBag.Title = "Ch·∫•m c√¥ng";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isManager = User.IsInRole("Admin_Tinh") || User.IsInRole("QuanLy_Xa");
    var schedule = ViewBag.Schedule as dynamic;
}

<div class="container-fluid p-3">
    <div class="row mb-3">
        <div class="col">
            <h3 class="text-success fw-bold">
                <i class="bi bi-clock-history"></i> Ch·∫•m c√¥ng
            </h3>
            <p class="text-muted mb-0">
                <i class="bi bi-person-badge"></i> @ViewBag.TenNV
                <span class="ms-3"><i class="bi bi-calendar-check"></i> <span id="currentDate"></span></span>
                <span class="ms-3"><i class="bi bi-clock"></i> <span id="currentTime"></span></span>
            </p>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle"></i> @TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Ch·∫•m c√¥ng nhanh -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-fingerprint"></i> Ch·∫•m c√¥ng</h5>
        </div>
        <div class="card-body text-center py-4">
            @if (schedule != null)
            {
                <div class="row g-3 justify-content-center">
                    <div class="col-md-4">
                        @using (Html.BeginForm("CheckInSimple", "ChamCong", FormMethod.Post, new { id = "formCheckIn" }))
                        {
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="maLich" value="@schedule.MaLich" />
                            <button type="submit" class="btn btn-success btn-lg w-100 py-4" @(schedule.DaCheckIn ? "disabled" : "")>
                                <i class="bi bi-box-arrow-in-right" style="font-size: 2rem;"></i>
                                <div class="mt-2 fw-bold">V√ÄO CA</div>
                                <small class="d-block">@DateTime.Now.ToString("HH:mm:ss")</small>
                            </button>
                        }
                    </div>
                    <div class="col-md-4">
                        @using (Html.BeginForm("CheckOutSimple", "ChamCong", FormMethod.Post, new { id = "formCheckOut" }))
                        {
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="maLich" value="@schedule.MaLich" />
                            <button type="submit" class="btn btn-danger btn-lg w-100 py-4" @(schedule.DaCheckOut || !schedule.DaCheckIn ? "disabled" : "")>
                                <i class="bi bi-box-arrow-right" style="font-size: 2rem;"></i>
                                <div class="mt-2 fw-bold">TAN CA</div>
                                <small class="d-block">@DateTime.Now.ToString("HH:mm:ss")</small>
                            </button>
                        }
                    </div>
                </div>
                
                <div class="mt-3">
                    @if (schedule.DaCheckOut)
                    {
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle"></i> <strong>ƒê√£ ho√†n th√†nh!</strong><br>
                            <small>V√†o: @schedule.GioVao | Ra: @schedule.GioRa | T·ªïng: @schedule.SoGioLam h</small>
                        </div>
                    }
                    else if (schedule.DaCheckIn)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-hourglass-split"></i> <strong>ƒêang l√†m vi·ªác</strong><br>
                            <small>Ca: @schedule.TenCa | V√†o l√∫c: @schedule.GioVao</small>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> <strong>Ca l√†m vi·ªác h√¥m nay</strong><br>
                            <small>
                                <strong>@schedule.TenCa</strong>: @schedule.GioBatDau - @schedule.GioKetThuc<br>
                                <strong>Khu v·ª±c:</strong> @schedule.TenLo<br>
                                <span class="text-muted">üí° C√≥ th·ªÉ v√†o ca t·ª´ 30 ph√∫t tr∆∞·ªõc gi·ªù b·∫Øt ƒë·∫ßu</span>
                            </small>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i> <strong>B·∫°n kh√¥ng c√≥ l·ªãch l√†m vi·ªác h√¥m nay (@DateTime.Today.ToString("dd/MM/yyyy"))</strong>
                    <p class="mb-2 mt-2">Vui l√≤ng li√™n h·ªá qu·∫£n l√Ω ƒë·ªÉ ƒë∆∞·ª£c ph√¢n c√¥ng l·ªãch l√†m vi·ªác.</p>
                    <small class="text-muted">M√£ nh√¢n vi√™n: @ViewBag.MaNV | T√™n: @ViewBag.TenNV</small>
                </div>
                <div class="text-center">
                    @if (User.IsInRole("Admin_Tinh") || User.IsInRole("QuanLy_Xa"))
                    {
                        <a href="@Url.Action("Index", "LichLamViec")" class="btn btn-primary">
                            <i class="bi bi-calendar-check"></i> Qu·∫£n l√Ω l·ªãch l√†m vi·ªác
                        </a>
                    }
                </div>
            }
        </div>
    </div>


    <!-- L·ªãch s·ª≠ ch·∫•m c√¥ng -->
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-journal-text"></i> L·ªãch s·ª≠ ch·∫•m c√¥ng (7 ng√†y g·∫ßn nh·∫•t)</h5>
            <div>
                @if (isManager)
                {
                    <a href="@Url.Action("QuanLy", "ChamCong")" class="btn btn-sm btn-warning me-2">
                        <i class="bi bi-people"></i> Xem t·∫•t c·∫£
                    </a>
                }
            </div>
        </div>
        <div class="card-body">
            @if (ViewBag.History != null && ((IEnumerable<dynamic>)ViewBag.History).Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>M√£ NV</th>
                                <th>Ng√†y</th>
                                <th>Ca l√†m vi·ªác</th>
                                <th>Gi·ªù v√†o</th>
                                <th>Gi·ªù ra</th>
                                <th>S·ªë gi·ªù l√†m</th>
                                <th>Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ViewBag.History)
                            {
                                <tr>
                                    <td><strong>@item.MaNV</strong></td>
                                    <td>@item.NgayLamViec</td>
                                    <td>@item.TenCa</td>
                                    <td>@(item.GioVao ?? "---")</td>
                                    <td>@(item.GioRa ?? "---")</td>
                                    <td>@(item.SoGioLam ?? "---")</td>
                                    <td>
                                        @if (item.TrangThai == "Ho√†n th√†nh")
                                        {
                                            <span class="badge bg-success">Ho√†n th√†nh</span>
                                        }
                                        else if (item.TrangThai == "ƒêang l√†m")
                                        {
                                            <span class="badge bg-warning text-dark">ƒêang l√†m</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Ch∆∞a ch·∫•m</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-3">Ch∆∞a c√≥ l·ªãch s·ª≠ ch·∫•m c√¥ng</div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Ch·ªâ c·∫≠p nh·∫≠t th·ªùi gian hi·ªÉn th·ªã
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN');
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });
    </script>
}

