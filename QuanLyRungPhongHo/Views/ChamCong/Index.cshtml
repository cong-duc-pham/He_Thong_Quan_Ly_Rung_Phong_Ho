@{
    ViewBag.Title = "Chấm công";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isManager = User.IsInRole("Admin_Tinh") || User.IsInRole("QuanLy_Xa");
    var schedule = ViewBag.Schedule as dynamic;
}

<div class="container-fluid p-3">
    <div class="row mb-3">
        <div class="col">
            <h3 class="text-success fw-bold">
                <i class="bi bi-clock-history"></i> Chấm công
            </h3>
            <p class="text-muted mb-0">
                <i class="bi bi-person-badge"></i> @ViewBag.TenNV
                <span class="ms-3"><i class="bi bi-calendar-check"></i> <span id="currentDate"></span></span>
                <span class="ms-3"><i class="bi bi-clock"></i> <span id="currentTime"></span></span>
            </p>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Chấm công nhanh -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-fingerprint"></i> Chấm công</h5>
        </div>
        <div class="card-body text-center py-4">
            @if (schedule != null)
            {
                <div class="row g-3 justify-content-center">
                    <div class="col-md-4">
                        @using (Html.BeginForm("CheckInSimple", "ChamCong", FormMethod.Post, new { id = "formCheckIn" }))
                        {
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="maLich" value="@schedule.MaLich" />
                            <button type="submit" class="btn btn-success btn-lg w-100 py-4" @(schedule.DaCheckIn ? "disabled" : "")>
                                <i class="bi bi-box-arrow-in-right" style="font-size: 2rem;"></i>
                                <div class="mt-2 fw-bold">VÀO CA</div>
                                <small class="d-block">@DateTime.Now.ToString("HH:mm:ss")</small>
                            </button>
                        }
                    </div>
                    <div class="col-md-4">
                        @using (Html.BeginForm("CheckOutSimple", "ChamCong", FormMethod.Post, new { id = "formCheckOut" }))
                        {
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="maLich" value="@schedule.MaLich" />
                            <button type="submit" class="btn btn-danger btn-lg w-100 py-4" @(schedule.DaCheckOut || !schedule.DaCheckIn ? "disabled" : "")>
                                <i class="bi bi-box-arrow-right" style="font-size: 2rem;"></i>
                                <div class="mt-2 fw-bold">TAN CA</div>
                                <small class="d-block">@DateTime.Now.ToString("HH:mm:ss")</small>
                            </button>
                        }
                    </div>
                </div>
                
                <div class="mt-3">
                    @if (schedule.DaCheckOut)
                    {
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle"></i> <strong>Đã hoàn thành!</strong><br>
                            <small>Vào: @schedule.GioVao | Ra: @schedule.GioRa | Tổng: @schedule.SoGioLam h</small>
                        </div>
                    }
                    else if (schedule.DaCheckIn)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-hourglass-split"></i> <strong>Đang làm việc</strong><br>
                            <small>Ca: @schedule.TenCa | Vào lúc: @schedule.GioVao</small>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> <strong>Ca làm việc hôm nay</strong><br>
                            <small>@schedule.TenCa | @schedule.GioBatDau - @schedule.GioKetThuc | @schedule.TenLo</small>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Bạn không có lịch làm việc hôm nay (@DateTime.Today.ToString("dd/MM/yyyy"))</strong>
                    <p class="mb-2 mt-2">Vui lòng liên hệ quản lý để được phân công lịch làm việc.</p>
                    <small class="text-muted">Mã nhân viên: @ViewBag.MaNV | Tên: @ViewBag.TenNV</small>
                </div>
                <div class="text-center">
                    <a href="@Url.Action("CreateTestSchedule", "ChamCong")" class="btn btn-success">
                        <i class="bi bi-calendar-plus"></i> Tạo lịch test cho hôm nay
                    </a>
                    @if (User.IsInRole("Admin_Tinh") || User.IsInRole("QuanLy_Xa"))
                    {
                        <a href="@Url.Action("Index", "LichLamViec")" class="btn btn-primary ms-2">
                            <i class="bi bi-calendar-check"></i> Quản lý lịch làm việc
                        </a>
                    }
                </div>
            }
        </div>
    </div>


    <!-- Lịch sử chấm công -->
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-journal-text"></i> Lịch sử chấm công (7 ngày gần nhất)</h5>
            <div>
                @if (isManager)
                {
                    <a href="@Url.Action("QuanLy", "ChamCong")" class="btn btn-sm btn-warning me-2">
                        <i class="bi bi-people"></i> Xem tất cả
                    </a>
                }
            </div>
        </div>
        <div class="card-body">
            @if (ViewBag.History != null && ((IEnumerable<dynamic>)ViewBag.History).Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ngày</th>
                                <th>Ca</th>
                                <th>Lô rừng</th>
                                <th>Giờ vào</th>
                                <th>Giờ ra</th>
                                <th>Số giờ</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ViewBag.History)
                            {
                                <tr>
                                    <td>@item.NgayLamViec</td>
                                    <td>@item.TenCa</td>
                                    <td>@item.TenLo</td>
                                    <td>@(item.GioVao ?? "---")</td>
                                    <td>@(item.GioRa ?? "---")</td>
                                    <td>@(item.SoGioLam ?? "---")</td>
                                    <td>
                                        @if (item.TrangThai == "Hoàn thành")
                                        {
                                            <span class="badge bg-success">Hoàn thành</span>
                                        }
                                        else if (item.TrangThai == "Đang làm")
                                        {
                                            <span class="badge bg-warning text-dark">Đang làm</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Chưa chấm</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-3">Chưa có lịch sử chấm công</div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Chỉ cập nhật thời gian hiển thị
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN');
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });
    </script>
}

