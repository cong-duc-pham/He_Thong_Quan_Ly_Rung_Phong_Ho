@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@model IEnumerable<QuanLyRungPhongHo.Models.LoRung>

@{
    ViewData["Title"] = Localizer["PageTitle"];
    var danhMucXa = ViewBag.DanhMucXa as List<QuanLyRungPhongHo.Models.DanhMucXa>;
    var loaiRung = ViewBag.LoaiRung as List<string>;
    var trangThai = ViewBag.TrangThai as List<string>;
    var currentPage = (int)ViewData["PageNumber"];
    var totalPages = (int)ViewData["TotalPages"];
    var totalRecords = (int)ViewData["TotalRecords"];
    var currentXa = ViewData["CurrentFilterXa"]?.ToString() ?? string.Empty;
    var currentThon = ViewData["CurrentFilterThon"]?.ToString() ?? string.Empty;
    var currentLoai = ViewData["CurrentFilterLoai"]?.ToString() ?? string.Empty;
    var currentTrangThai = ViewData["CurrentFilterTrangThai"]?.ToString() ?? string.Empty;
}

@section Styles {
    <link rel="stylesheet" href="~/css/digioi.css" asp-append-version="true" />
}

<div class="digioi-page"
    id="lorung-page"
    data-endpoint="@Url.Action("GetPaged", "LoRung")"
    data-pagesize="15"
    data-initial-page="@currentPage"
    data-initial-xa="@currentXa"
    data-initial-thon="@currentThon"
    data-initial-loai="@currentLoai"
    data-initial-trangthai="@currentTrangThai">

    <!-- Header -->
    <div class="digioi-header">
        <h2>
            <i class="bi bi-tree"></i> @Localizer["PageHeader"]
        </h2>
        <a asp-action="Create" class="digioi-btn digioi-btn-success">
            <i class="bi bi-plus-circle"></i> @Localizer["AddForestLot"]
        </a>
    </div>

    @* Thông báo *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="digioi-alert digioi-alert-success">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="digioi-alert digioi-alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        </div>
    }

    <!-- Bộ lọc -->
    <div class="digioi-card digioi-filter-card">
        <form asp-action="Index" method="get" class="digioi-filter-form no-ajax" id="lorung-filter-form">
            <div class="digioi-form-group">
                <label>
                    <i class="bi bi-building"></i> @Localizer["FilterCommune"]
                </label>
                <select name="searchXa" id="filterXa">
                    <option value="">@Localizer["AllCommunes"]</option>
                    @foreach (var xa in danhMucXa)
                    {
                        <option value="@xa.MaXa" selected="@(ViewData["CurrentFilterXa"]?.ToString() == xa.MaXa)">
                            @xa.TenXa
                        </option>
                    }
                </select>
            </div>

            <div class="digioi-form-group">
                <label>
                    <i class="bi bi-geo-alt"></i> @Localizer["FilterVillage"]
                </label>
                <select name="searchThon" id="filterThon" data-selected="@ViewData["CurrentFilterThon"]">
                    <option value="">@Localizer["AllVillages"]</option>
                </select>
            </div>

            <div class="digioi-form-group">
                <label>
                    <i class="bi bi-tree-fill"></i> @Localizer["FilterForestType"]
                </label>
                <select name="searchLoai" id="filterLoai">
                    <option value="">@Localizer["AllTypes"]</option>
                    @foreach (var loai in loaiRung)
                    {
                        <option value="@loai" selected="@(ViewData["CurrentFilterLoai"]?.ToString() == loai)">
                            @loai
                        </option>
                    }
                </select>
            </div>

            <div class="digioi-form-group">
                <label>
                    <i class="bi bi-info-circle"></i> @Localizer["FilterStatus"]
                </label>
                <select name="searchTrangThai" id="filterTrangThai">
                    <option value="">@Localizer["AllStatuses"]</option>
                    @foreach (var tt in trangThai)
                    {
                        <option value="@tt" selected="@(ViewData["CurrentFilterTrangThai"]?.ToString() == tt)">
                            @tt
                        </option>
                    }
                </select>
            </div>

            <div class="digioi-form-group">
                <label>&nbsp;</label>
                <button type="submit" class="digioi-btn digioi-btn-success">
                    <i class="bi bi-search"></i> @Localizer["Filter"]
                </button>
            </div>
        </form>
    </div>

    <!-- Kết quả -->
    <div class="digioi-info-bar">
        <span class="digioi-badge digioi-badge-info" id="lorung-total">
            @Localizer["Total"]: @ViewData["TotalRecords"] @Localizer["ForestLots"]
        </span>
        <a asp-action="Index" id="lorung-reset-filters" class="digioi-btn digioi-btn-outline">
            <i class="bi bi-x-circle"></i> @Localizer["ClearFilter"]
        </a>
    </div>

    <!-- Bảng -->
    <div class="digioi-card">
        <div class="digioi-table-wrap">
            <table class="digioi-table">
                <thead>
                    <tr>
                        <th>@Localizer["Index"]</th>
                        <th>@Localizer["SubCompartment"]</th>
                        <th>@Localizer["Compartment"]</th>
                        <th>@Localizer["Lot"]</th>
                        <th>@Localizer["Village"]</th>
                        <th>@Localizer["Commune"]</th>
                        <th>@Localizer["Area"]</th>
                        <th>@Localizer["ForestType"]</th>
                        <th>@Localizer["Status"]</th>
                        <th>@Localizer["Action"]</th>
                    </tr>
                </thead>
                <tbody id="lorung-table-body">
                    @if (Model.Any())
                    {
                        int stt = (currentPage - 1) * 15 + 1;
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>@stt</td>
                                <td><strong>@(item.SoTieuKhu?.ToString() ?? "—")</strong></td>
                                <td><strong>@(item.SoKhoanh?.ToString() ?? "—")</strong></td>
                                <td><strong>@(item.SoLo?.ToString() ?? "—")</strong></td>
                                <td>@item.DanhMucThon?.TenThon</td>
                                <td>
                                    <span class="digioi-badge digioi-badge-success">@item.DanhMucThon?.DanhMucXa?.TenXa</span>
                                </td>
                                <td data-type="area">
                                    @(item.DienTich?.ToString("N2") ?? "—")
                                </td>
                                <td>@item.LoaiRung</td>
                                <td>
                                    @{
                                        var badgeClass = item.TrangThai switch
                                        {
                                            "Rừng giàu" => "digioi-badge-success",
                                            "Rừng trung bình" => "digioi-badge-info",
                                            "Rừng nghèo" => "digioi-badge-warning",
                                            "Đất trống" => "digioi-badge-secondary",
                                            _ => "digioi-badge-secondary"
                                        };
                                    }
                                    <span class="digioi-badge @badgeClass">@item.TrangThai</span>
                                </td>
                                <td>
                                    <div class="digioi-btn-group">
                                        <a asp-action="Edit" asp-route-id="@item.MaLo" class="digioi-btn digioi-btn-warning">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <a asp-action="Delete" asp-route-id="@item.MaLo" class="digioi-btn digioi-btn-danger">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            stt++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="10" class="digioi-empty">
                                <i class="bi bi-inbox"></i>
                                <p>@Localizer["NoData"]</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @if (totalPages > 1)
    {
        <div class="digioi-pagination" id="lorung-pagination">
            <a class="digioi-page @(currentPage == 1 ? "disabled" : "")"
               data-page="@(currentPage - 1)"
               asp-action="Index"
               asp-route-pageNumber="@(currentPage - 1)"
               asp-route-searchXa="@currentXa"
               asp-route-searchThon="@currentThon"
               asp-route-searchLoai="@currentLoai"
               asp-route-searchTrangThai="@currentTrangThai">
                ‹
            </a>

            @for (int i = 1; i <= totalPages; i++)
            {
                <a class="digioi-page @(i == currentPage ? "active" : "")"
                   data-page="@i"
                   asp-action="Index"
                   asp-route-pageNumber="@i"
                   asp-route-searchXa="@currentXa"
                   asp-route-searchThon="@currentThon"
                   asp-route-searchLoai="@currentLoai"
                   asp-route-searchTrangThai="@currentTrangThai">
                    @i
                </a>
            }

            <a class="digioi-page @(currentPage == totalPages ? "disabled" : "")"
               data-page="@(currentPage + 1)"
               asp-action="Index"
               asp-route-pageNumber="@(currentPage + 1)"
               asp-route-searchXa="@currentXa"
               asp-route-searchThon="@currentThon"
               asp-route-searchLoai="@currentLoai"
               asp-route-searchTrangThai="@currentTrangThai">
                ›
            </a>
        </div>

        <div class="digioi-page-info">
            @Localizer["Page"] @currentPage / @totalPages
        </div>
    }
</div>
