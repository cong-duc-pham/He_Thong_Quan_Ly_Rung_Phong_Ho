@inject IViewLocalizer Localizer
@model QuanLyRungPhongHo.Models.ViewModels.BaoCaoThongKeViewModel

@{
    ViewData["Title"] = "Báo cáo Thống kê";
}

@section Styles {
    <link rel="stylesheet" href="~/css/baocao-thongke.css" asp-append-version="true" />
}

<div class="digioi-page">
    <!-- HEADER -->
    <div class="digioi-header">
        <h2>
            <i class="bi bi-graph-up-arrow"></i> @Localizer["PageTitle"]
        </h2>
        <div style="display: flex; gap: 12px;">
            <button type="button" class="digioi-btn digioi-btn-success" data-bs-toggle="modal" data-bs-target="#exportExcelModal" title="@Localizer["ExportExcelTooltip"]">
                <i class="bi bi-file-earmark-spreadsheet"></i> @Localizer["ExportExcel"]
            </button>
            <button type="button" class="digioi-btn digioi-btn-danger" data-bs-toggle="modal" data-bs-target="#exportPdfModal" title="@Localizer["ExportPDFTooltip"]">
                <i class="bi bi-file-earmark-pdf"></i> @Localizer["ExportPDF"]
            </button>
        </div>
    </div>

    @* THÔNG BÁO từ Controller *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="digioi-alert digioi-alert-success">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="digioi-alert digioi-alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        </div>
    }

    <!-- BỘ LỌC -->
    <div class="digioi-card digioi-filter-card">
        <form asp-action="Index" method="get" class="digioi-filter-form">
            <div class="digioi-form-group">
                <label>
                    <i class="bi bi-building"></i> @Localizer["Commune"]
                </label>
                <select name="maXaFilter" class="form-select">
                    <option value="">-- @Localizer["AllCommunes"] --</option>
                    @foreach (var xa in Model.DanhSachXa)
                    {
                        <option value="@xa.MaXa" selected="@(Model.MaXaFilter == xa.MaXa)">
                            @xa.TenXa
                        </option>
                    }
                </select>
            </div>

            <div class="digioi-form-group">
                <label>
                    <i class="bi bi-calendar"></i> @Localizer["FromDate"]
                </label>
                <input type="date"
                       name="tuNgay"
                       value="@Model.TuNgay?.ToString("yyyy-MM-dd")"
                       class="form-control"
                       title="@Localizer["FromDateTooltip"]" />
            </div>

            <div class="digioi-form-group">
                <label>
                    <i class="bi bi-calendar-check"></i> @Localizer["ToDate"]
                </label>
                <input type="date"
                       name="denNgay"
                       value="@Model.DenNgay?.ToString("yyyy-MM-dd")"
                       class="form-control"
                       title="@Localizer["ToDateTooltip"]" />
            </div>

            <div class="digioi-form-group">
                <label>&nbsp;</label>
                <button type="submit" class="digioi-btn digioi-btn-success">
                    <i class="bi bi-search"></i> @Localizer["Filter"]
                </button>
            </div>
        </form>
    </div>

    <!-- THỐNG KÊ TỔNG QUAN -->
    <div class="stats-grid">
        <div class="stat-card" title="@Localizer["TotalCommunesTooltip"]">
            <div class="stat-icon">
                <i class="bi bi-building"></i>
            </div>
            <div class="stat-label">@Localizer["TotalCommunes"]</div>
            <div class="stat-value">@Model.TongSoXa</div>
        </div>

        <div class="stat-card" title="@Localizer["TotalVillagesTooltip"]">
            <div class="stat-icon">
                <i class="bi bi-geo-alt"></i>
            </div>
            <div class="stat-label">@Localizer["TotalVillages"]</div>
            <div class="stat-value">@Model.TongSoThon</div>
        </div>

        <div class="stat-card" title="@Localizer["TotalForestLotsTooltip"]">
            <div class="stat-icon">
                <i class="bi bi-tree"></i>
            </div>
            <div class="stat-label">@Localizer["TotalForestLots"]</div>
            <div class="stat-value">@Model.TongSoLoRung</div>
        </div>

        <div class="stat-card" title="@Localizer["TotalAreaTooltip"]">
            <div class="stat-icon">
                <i class="bi bi-badge-3d"></i>
            </div>
            <div class="stat-label">@Localizer["TotalArea"]</div>
            <div class="stat-value">
                @Model.TongDienTichRung.ToString("N2")
                <span class="stat-unit">ha</span>
            </div>
        </div>

        <div class="stat-card" title="@Localizer["TotalPersonnelTooltip"]">
            <div class="stat-icon">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-label">@Localizer["TotalPersonnel"]</div>
            <div class="stat-value">@Model.TongSoNhanSu</div>
        </div>

        <div class="stat-card" title="@Localizer["WildlifeRecordedTooltip"]">
            <div class="stat-icon">
                <i class="bi bi-bug"></i>
            </div>
            <div class="stat-label">@Localizer["WildlifeRecorded"]</div>
            <div class="stat-value">@Model.TongSoSinhVat</div>
        </div>

        <div class="stat-card" title="@Localizer["ProtectionEventsTooltip"]">
            <div class="stat-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stat-label">@Localizer["ProtectionEvents"]</div>
            <div class="stat-value">@Model.TongSoSuKien</div>
        </div>
    </div>

    <!-- THỐNG KÊ THEO LOẠI RỪNG -->
    @if (Model.ThongKeTheoLoaiRung.Any())
    {
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-bar-chart-fill"></i>
                @Localizer["StatsByForestType"]
            </div>

            @foreach (var item in Model.ThongKeTheoLoaiRung)
            {
                <div class="mb-3">
                    <div class="progress-label">
                        <span class="progress-label-name">
                            <i class="bi bi-tree-fill text-success"></i> @item.LoaiRung
                        </span>
                        <span class="progress-label-value">
                            @item.SoLuongLo lô | @item.TongDienTich.ToString("N2") ha | @item.TyLe%
                        </span>
                    </div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" style="width: @item.TyLe%">
                            @item.TyLe%
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- THỐNG KÊ THEO TRẠNG THÁI -->
    @if (Model.ThongKeTheoTrangThai.Any())
    {
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-pie-chart-fill"></i>
                @Localizer["StatsByStatus"]
            </div>

            @foreach (var item in Model.ThongKeTheoTrangThai)
            {
                var badgeClass = item.TrangThai switch
                {
                    "Rừng giàu" => "badge-success-custom",
                    "Rừng trung bình" => "badge-info-custom",
                    "Rừng nghèo" => "badge-warning-custom",
                    "Đất trống" => "badge-danger-custom",
                    _ => "badge-secondary"
                };

                <div class="mb-3">
                    <div class="progress-label">
                        <span class="progress-label-name">
                            <span class="badge-custom @badgeClass">@item.TrangThai</span>
                        </span>
                        <span class="progress-label-value">
                            @item.SoLuongLo @Localizer["Lots"] | @item.TongDienTich.ToString("N2") ha | @item.TyLe%
                        </span>
                    </div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" style="width: @item.TyLe%">
                            @item.TyLe%
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- THỐNG KÊ THEO XÃ -->
    @if (Model.ThongKeTheoXa.Any())
    {
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-table"></i>
                @Localizer["StatsByCommune"]
            </div>

            <div class="digioi-table-wrap">
                <table class="digioi-table table-compact">
                    <thead>
                        <tr>
                            <th>@Localizer["OrderNumber"]</th>
                            <th>@Localizer["CommuneName"]</th>
                            <th>@Localizer["VillageCount"]</th>
                            <th>@Localizer["ForestLotCount"]</th>
                            <th>@Localizer["TotalAreaHa"]</th>
                            <th>@Localizer["Personnel"]</th>
                            <th>@Localizer["Events"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int stt = 1;
                        }
                        @foreach (var item in Model.ThongKeTheoXa)
                        {
                            <tr title="Nhấn để chọn dòng @item.TenXa">
                                <td>@stt</td>
                                <td><strong>@item.TenXa</strong></td>
                                <td>@item.SoThon</td>
                                <td>@item.SoLoRung</td>
                                <td>@item.TongDienTich.ToString("N2")</td>
                                <td>@item.SoNhanSu</td>
                                <td>@item.SoSuKien</td>
                            </tr>
                            stt++;
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2">@Localizer["GrandTotal"]</td>
                            <td>@Model.ThongKeTheoXa.Sum(x => x.SoThon)</td>
                            <td>@Model.ThongKeTheoXa.Sum(x => x.SoLoRung)</td>
                            <td>@Model.ThongKeTheoXa.Sum(x => x.TongDienTich).ToString("N2")</td>
                            <td>@Model.ThongKeTheoXa.Sum(x => x.SoNhanSu)</td>
                            <td>@Model.ThongKeTheoXa.Sum(x => x.SoSuKien)</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    }

    <!-- THỐNG KÊ SỰ KIỆN BẢO VỆ -->
    @if (Model.ThongKeSuKienBaoVe.Any())
    {
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-shield-check"></i>
                @Localizer["ProtectionEventStats"]
                @if (Model.TuNgay.HasValue || Model.DenNgay.HasValue)
                {
                    <span style="font-size: 14px; color: #6c757d; font-weight: normal;">
                        (@(Model.TuNgay?.ToString("dd/MM/yyyy") ?? "...") - @(Model.DenNgay?.ToString("dd/MM/yyyy") ?? "..."))
                    </span>
                }
            </div>

            <div class="digioi-table-wrap">
                <table class="digioi-table table-compact">
                    <thead>
                        <tr>
                            <th>@Localizer["EventType"]</th>
                            <th>@Localizer["Quantity"]</th>
                            <th>@Localizer["Ratio"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.ThongKeSuKienBaoVe)
                        {
                            <tr>
                                <td><strong>@item.LoaiSuViec</strong></td>
                                <td>@item.SoLuong</td>
                                <td>
                                    <span class="badge-custom badge-info-custom">@item.TyLe%</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- THỐNG KÊ SINH VẬT -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="bi bi-bug-fill"></i>
            @Localizer["WildlifeStats"]
        </div>

        <div class="stats-grid sinh-vat" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
            <div class="stat-card" style="border-left-color: #0dcaf0;">
                <div class="stat-label">@Localizer["TotalAnimals"]</div>
                <div class="stat-value" style="color: #0dcaf0;">@Model.TongDongVat</div>
            </div>
            <div class="stat-card" style="border-left-color: #198754;">
                <div class="stat-label">@Localizer["TotalPlants"]</div>
                <div class="stat-value" style="color: #198754;">@Model.TongThucVat</div>
            </div>
            <div class="stat-card" style="border-left-color: #ffc107;">
                <div class="stat-label">@Localizer["RareSpecies"]</div>
                <div class="stat-value" style="color: #ffc107;">@Model.SoLoaiQuyHiem</div>
            </div>
            <div class="stat-card" style="border-left-color: #dc3545;">
                <div class="stat-label">@Localizer["EndangeredSpecies"]</div>
                <div class="stat-value" style="color: #dc3545;">@Model.SoLoaiNguyCap</div>
            </div>
        </div>

        @if (Model.Top10SinhVat.Any())
        {
            <h6 style="font-weight: 600; color: var(--green); margin-bottom: 16px;">
                <i class="bi bi-trophy"></i> @Localizer["Top10Wildlife"]
            </h6>

            <div class="digioi-table-wrap">
                <table class="digioi-table table-compact">
                    <thead>
                        <tr>
                            <th>@Localizer["Rank"]</th>
                            <th>@Localizer["SpeciesName"]</th>
                            <th>@Localizer["Type"]</th>
                            <th>@Localizer["RarityLevel"]</th>
                            <th>@Localizer["RecordCount"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int rank = 1;
                        }
                        @foreach (var item in Model.Top10SinhVat)
                        {
                            var badgeClass = item.MucDoQuyHiem switch
                            {
                                "Cực kỳ nguy cấp" => "badge-danger-custom",
                                "Nguy cấp" => "badge-warning-custom",
                                "Sắp nguy cấp" => "badge-info-custom",
                                _ => "badge-secondary"
                            };

                            <tr title="Loài @item.TenLoai - Ghi nhận @item.SoLuongGhiNhan lần">
                                <td>
                                    @if (rank <= 3)
                                    {
                                        <i class="bi bi-trophy-fill text-warning"></i>
                                    }
                                    <strong>@rank</strong>
                                </td>
                                <td><strong>@item.TenLoai</strong></td>
                                <td>@item.LoaiSV</td>
                                <td>
                                    <span class="badge-custom @badgeClass">@item.MucDoQuyHiem</span>
                                </td>
                                <td><strong>@item.SoLuongGhiNhan</strong></td>
                            </tr>
                            rank++;
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- FOOTER -->
    <div class="report-footer">
        <p>
            <i class="bi bi-info-circle"></i>
            @Localizer["AutoGeneratedNote"]
        </p>
        <p>
            @Localizer["GeneratedTime"]: @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")
        </p>
    </div>
</div>

<!-- MODAL XUẤT EXCEL -->
<div class="modal fade" id="exportExcelModal" tabindex="-1" aria-labelledby="exportExcelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportExcelModalLabel">
                    <i class="bi bi-file-earmark-spreadsheet"></i> @Localizer["ExportExcelTitle"]
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportExcelForm">
                    <!-- Chọn phạm vi xuất -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-geo-alt"></i> @Localizer["ReportScope"]
                        </label>
                        <select class="form-select" id="exportMaXaFilter" name="maXaFilter">
                            <option value="">@Localizer["ProvinceWide"]</option>
                            @foreach (var xa in Model.DanhSachXa)
                            {
                                <option value="@xa.MaXa" selected="@(Model.MaXaFilter == xa.MaXa)">@xa.TenXa</option>
                            }
                        </select>
                    </div>

                    <!-- Chọn khoảng thời gian -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> @Localizer["FromDate"]
                            </label>
                            <input type="date" class="form-control" id="exportTuNgay" name="tuNgay" value="@Model.TuNgay?.ToString("yyyy-MM-dd")">
                            <small class="text-danger d-none" id="exportTuNgayError">
                                <i class="bi bi-exclamation-circle"></i> <span id="exportTuNgayErrorMsg"></span>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar-check"></i> @Localizer["ToDate"]
                            </label>
                            <input type="date" class="form-control" id="exportDenNgay" name="denNgay" value="@Model.DenNgay?.ToString("yyyy-MM-dd")">
                            <small class="text-danger d-none" id="exportDenNgayError">
                                <i class="bi bi-exclamation-circle"></i> <span id="exportDenNgayErrorMsg"></span>
                            </small>
                        </div>
                    </div>

                    <!-- Chọn nội dung xuất -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-list-check"></i> @Localizer["ExportContent"]
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportTongQuan" checked>
                            <label class="form-check-label" for="exportTongQuan">
                                @Localizer["OverviewStats"]
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportLoaiRung" checked>
                            <label class="form-check-label" for="exportLoaiRung">
                                @Localizer["ForestTypeStats"]
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportTrangThai" checked>
                            <label class="form-check-label" for="exportTrangThai">
                                @Localizer["ForestStatusStats"]
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportTheoXa" checked>
                            <label class="form-check-label" for="exportTheoXa">
                                @Localizer["AdministrativeStats"]
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="exportSuKien" checked>
                            <label class="form-check-label" for="exportSuKien">
                                @Localizer["ProtectionEventStats2"]
                            </label>
                        </div>
                    </div>

                    <!-- Tên file tự động -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-file-text"></i> @Localizer["AutoFileName"]
                        </label>
                        <input type="text" class="form-control" id="exportFileName" readonly 
                               placeholder="BaoCao_ToanTinh_20250203_084530.xlsx">
                        <small class="text-muted">@Localizer["FileNameHelp"]</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> @Localizer["Cancel"]
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmExportExcel">
                    <i class="bi bi-download"></i> @Localizer["ExportExcelButton"]
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL XUẤT PDF -->
<div class="modal fade" id="exportPdfModal" tabindex="-1" aria-labelledby="exportPdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportPdfModalLabel">
                    <i class="bi bi-file-earmark-pdf"></i> @Localizer["ExportPDFTitle"]
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportPdfForm">
                    <!-- Chọn phạm vi xuất -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-geo-alt"></i> @Localizer["ReportScope"]
                        </label>
                        <select class="form-select" id="pdfMaXaFilter" name="maXaFilter">
                            <option value="">@Localizer["ProvinceWide"]</option>
                            @foreach (var xa in Model.DanhSachXa)
                            {
                                <option value="@xa.MaXa" selected="@(Model.MaXaFilter == xa.MaXa)">@xa.TenXa</option>
                            }
                        </select>
                    </div>

                    <!-- Chọn khoảng thời gian -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> @Localizer["FromDate"]
                            </label>
                            <input type="date" class="form-control" id="pdfTuNgay" name="tuNgay" value="@Model.TuNgay?.ToString("yyyy-MM-dd")">
                            <small class="text-danger d-none" id="pdfTuNgayError">
                                <i class="bi bi-exclamation-circle"></i> <span id="pdfTuNgayErrorMsg"></span>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar-check"></i> @Localizer["ToDate"]
                            </label>
                            <input type="date" class="form-control" id="pdfDenNgay" name="denNgay" value="@Model.DenNgay?.ToString("yyyy-MM-dd")">
                            <small class="text-danger d-none" id="pdfDenNgayError">
                                <i class="bi bi-exclamation-circle"></i> <span id="pdfDenNgayErrorMsg"></span>
                            </small>
                        </div>
                    </div>

                    <!-- Tên file tự động -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-file-text"></i> @Localizer["AutoFileName"]
                        </label>
                        <input type="text" class="form-control" id="pdfFileName" readonly 
                               placeholder="BaoCao_ToanTinh_20250203_084530.pdf">
                        <small class="text-muted">@Localizer["PDFFileNameHelp"]</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> @Localizer["Cancel"]
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmExportPdf">
                    <i class="bi bi-file-pdf"></i> @Localizer["ExportPDFButton"]
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/baocao-thongke.js" asp-append-version="true"></script>                    
    <script>
        // Hiển thị thông báo nếu có lỗi từ TempData
        @if (TempData["ErrorMessage"] != null)
        {
            <text>
            setTimeout(function() {
                BaoCaoThongKe.showToast('@TempData["ErrorMessage"]', 'error');
            }, 500);
            </text>
        }
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
            setTimeout(function() {
                BaoCaoThongKe.showToast('@TempData["SuccessMessage"]', 'success');
            }, 500);
            </text>
        }
    </script>
}